'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _toConsumableArray2 = require('babel-runtime/helpers/toConsumableArray');

var _toConsumableArray3 = _interopRequireDefault(_toConsumableArray2);

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _memoizeOne = require('memoize-one');

var _memoizeOne2 = _interopRequireDefault(_memoizeOne);

var _propTypes = require('prop-types');

var _propTypes2 = _interopRequireDefault(_propTypes);

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _Context = require('./Context');

var _Context2 = _interopRequireDefault(_Context);

var _Utterance = require('./Utterance');

var _Utterance2 = _interopRequireDefault(_Utterance);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var SpeechContext = function () {
  function SpeechContext(ponyfill) {
    (0, _classCallCheck3.default)(this, SpeechContext);

    this.queueWithCurrent = [];

    this.cancel = this.cancel.bind(this);
    this.cancelAll = this.cancelAll.bind(this);
    this.speak = this.speak.bind(this);

    this.setPonyfill(ponyfill);
  }

  (0, _createClass3.default)(SpeechContext, [{
    key: 'setPonyfill',
    value: function setPonyfill(_ref) {
      var speechSynthesis = _ref.speechSynthesis,
          SpeechSynthesisUtterance = _ref.SpeechSynthesisUtterance;

      this.ponyfill = { speechSynthesis: speechSynthesis, SpeechSynthesisUtterance: SpeechSynthesisUtterance };
    }
  }, {
    key: 'cancel',
    value: function () {
      var _ref2 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee(id) {
        var index;
        return _regenerator2.default.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                index = this.queueWithCurrent.findIndex(function (utterance) {
                  return utterance.id === id;
                });

                if (!~index) {
                  _context.next = 3;
                  break;
                }

                return _context.abrupt('return', this.queueWithCurrent[index].cancel());

              case 3:
              case 'end':
                return _context.stop();
            }
          }
        }, _callee, this);
      }));

      function cancel(_x) {
        return _ref2.apply(this, arguments);
      }

      return cancel;
    }()
  }, {
    key: 'cancelAll',
    value: function () {
      var _ref3 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2() {
        return _regenerator2.default.wrap(function _callee2$(_context2) {
          while (1) {
            switch (_context2.prev = _context2.next) {
              case 0:
              case 'end':
                return _context2.stop();
            }
          }
        }, _callee2, this);
      }));

      function cancelAll() {
        return _ref3.apply(this, arguments);
      }

      return cancelAll;
    }()
  }, {
    key: 'speak',
    value: function speak(utteranceLike) {
      // console.debug(`QUEUED: ${ utteranceLike.text }`);

      if (utteranceLike.id && this.queueWithCurrent.find(function (_ref4) {
        var id = _ref4.id;
        return id === utteranceLike.id;
      })) {
        // Do not queue duplicated speak with same unique ID
        // console.debug('NOT QUEUEING DUPE');

        return;
      }

      var utterance = new _Utterance2.default(utteranceLike);

      this.queueWithCurrent = [].concat((0, _toConsumableArray3.default)(this.queueWithCurrent), [utterance]);

      if (this.queueWithCurrent.length === 1) {
        this._next();
      }

      return utterance.deferred.promise;
    }
  }, {
    key: '_next',
    value: function _next() {
      var _this = this;

      var utterance = this.queueWithCurrent[0];

      if (!utterance) {
        return;
      }

      var id = utterance.id;

      var promise = utterance.speak(this.ponyfill);

      promise.then(function () {
        _this.queueWithCurrent = _this.queueWithCurrent.filter(function (utterance) {
          return utterance.id !== id;
        });
        _this._next();
      }, function () {
        // TODO: If the error is due to Safari restriction on user touch
        //       The next loop on the next audio will also fail because it was not queued with a user touch
        _this.queueWithCurrent = _this.queueWithCurrent.filter(function (utterance) {
          return utterance.id !== id;
        });
        _this._next();
      });
    }
  }]);
  return SpeechContext;
}();

var Composer = function (_React$Component) {
  (0, _inherits3.default)(Composer, _React$Component);

  function Composer(props) {
    (0, _classCallCheck3.default)(this, Composer);

    var _this2 = (0, _possibleConstructorReturn3.default)(this, (Composer.__proto__ || (0, _getPrototypeOf2.default)(Composer)).call(this, props));

    _this2.handleVoicesChanged = _this2.handleVoicesChanged.bind(_this2);

    var voices = [];

    if (props.speechSynthesis) {
      props.speechSynthesis.addEventListener && props.speechSynthesis.addEventListener('voiceschanged', _this2.handleVoicesChanged);
      voices = props.speechSynthesis.getVoices();
    }

    _this2.mergeContext = (0, _memoizeOne2.default)(function (_ref5, voices) {
      var cancel = _ref5.cancel,
          speak = _ref5.speak;
      return {
        cancel: cancel,
        speak: speak,
        voices: voices
      };
    });

    _this2.state = {
      context: new SpeechContext({
        speechSynthesis: props.speechSynthesis,
        SpeechSynthesisUtterance: props.speechSynthesisUtterance
      }),
      voices: voices
    };
    return _this2;
  }

  (0, _createClass3.default)(Composer, [{
    key: 'componentWillReceiveProps',
    value: function componentWillReceiveProps(nextProps) {
      var props = this.props;

      var changed = ['speechSynthesis', 'speechSynthesisUtterance'].some(function (name) {
        return nextProps[name] !== props[name];
      });

      if (changed) {
        if (props.speechSynthesis) {
          props.speechSynthesis.removeEventListener && props.speechSynthesis.removeEventListener('voiceschanged', this.handleVoicesChanged);
        }

        this.state.context.setPonyfill({
          speechSynthesis: nextProps.speechSynthesis,
          SpeechSynthesisUtterance: nextProps.speechSynthesisUtterance
        });

        var nextVoices = [];

        if (nextProps.speechSynthesis) {
          nextProps.speechSynthesis.addEventListener && nextProps.speechSynthesis.addEventListener('voiceschanged', this.handleVoicesChanged);
          nextVoices = nextProps.speechSynthesis.getVoices() || [];
        }

        this.setState(function () {
          return { voices: nextVoices };
        });
      }
    }
  }, {
    key: 'componentWillUnmount',
    value: function componentWillUnmount() {
      var speechSynthesis = this.props.speechSynthesis;


      speechSynthesis && speechSynthesis.removeEventListener && speechSynthesis.removeEventListener('voiceschanged', this.handleVoicesChanged);
    }
  }, {
    key: 'handleVoicesChanged',
    value: function handleVoicesChanged(_ref6) {
      var target = _ref6.target;

      this.setState(function () {
        return { voices: target.getVoices() };
      });
    }
  }, {
    key: 'render',
    value: function render() {
      var _this3 = this;

      var props = this.props,
          state = this.state;
      var children = props.children;


      return _react2.default.createElement(
        _Context2.default.Consumer,
        null,
        function (context) {
          return context ? typeof children === 'function' ? children(context) : children : _react2.default.createElement(
            _Context2.default.Provider,
            { value: _this3.mergeContext(state.context, state.voices) },
            typeof children === 'function' ? _react2.default.createElement(
              _Context2.default.Consumer,
              null,
              function (context) {
                return children(context);
              }
            ) : children
          );
        }
      );
    }
  }]);
  return Composer;
}(_react2.default.Component);

exports.default = Composer;


Composer.defaultProps = {
  speechSynthesis: window.speechSynthesis || window.webkitSpeechSynthesis,
  speechSynthesisUtterance: window.SpeechSynthesisUtterance || window.webkitSpeechSynthesisUtterance
};

Composer.propTypes = {
  speechSynthesis: _propTypes2.default.any,
  speechSynthesisUtterance: _propTypes2.default.any
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Db21wb3Nlci5qcyJdLCJuYW1lcyI6WyJTcGVlY2hDb250ZXh0IiwicG9ueWZpbGwiLCJxdWV1ZVdpdGhDdXJyZW50IiwiY2FuY2VsIiwiYmluZCIsImNhbmNlbEFsbCIsInNwZWFrIiwic2V0UG9ueWZpbGwiLCJzcGVlY2hTeW50aGVzaXMiLCJTcGVlY2hTeW50aGVzaXNVdHRlcmFuY2UiLCJpZCIsImluZGV4IiwiZmluZEluZGV4IiwidXR0ZXJhbmNlIiwidXR0ZXJhbmNlTGlrZSIsImZpbmQiLCJVdHRlcmFuY2UiLCJsZW5ndGgiLCJfbmV4dCIsImRlZmVycmVkIiwicHJvbWlzZSIsInRoZW4iLCJmaWx0ZXIiLCJDb21wb3NlciIsInByb3BzIiwiaGFuZGxlVm9pY2VzQ2hhbmdlZCIsInZvaWNlcyIsImFkZEV2ZW50TGlzdGVuZXIiLCJnZXRWb2ljZXMiLCJtZXJnZUNvbnRleHQiLCJzdGF0ZSIsImNvbnRleHQiLCJzcGVlY2hTeW50aGVzaXNVdHRlcmFuY2UiLCJuZXh0UHJvcHMiLCJjaGFuZ2VkIiwic29tZSIsIm5hbWUiLCJyZW1vdmVFdmVudExpc3RlbmVyIiwibmV4dFZvaWNlcyIsInNldFN0YXRlIiwidGFyZ2V0IiwiY2hpbGRyZW4iLCJSZWFjdCIsIkNvbXBvbmVudCIsImRlZmF1bHRQcm9wcyIsIndpbmRvdyIsIndlYmtpdFNwZWVjaFN5bnRoZXNpcyIsIndlYmtpdFNwZWVjaFN5bnRoZXNpc1V0dGVyYW5jZSIsInByb3BUeXBlcyIsIlByb3BUeXBlcyIsImFueSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFFQTs7OztBQUNBOzs7Ozs7SUFFTUEsYTtBQUNKLHlCQUFZQyxRQUFaLEVBQXNCO0FBQUE7O0FBQ3BCLFNBQUtDLGdCQUFMLEdBQXdCLEVBQXhCOztBQUVBLFNBQUtDLE1BQUwsR0FBYyxLQUFLQSxNQUFMLENBQVlDLElBQVos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LFM7O2tCQUF2QnBCLFE7OztBQTJGckJBLFNBQVNxQixZQUFULEdBQXdCO0FBQ3RCcEMsbUJBQWlCcUMsT0FBT3JDLGVBQVAsSUFBMEJxQyxPQUFPQyxxQkFENUI7QUFFdEJkLDRCQUEwQmEsT0FBT3BDLHdCQUFQLElBQW1Db0MsT0FBT0U7QUFGOUMsQ0FBeEI7O0FBS0F4QixTQUFTeUIsU0FBVCxHQUFxQjtBQUNuQnhDLG1CQUFpQnlDLG9CQUFVQyxHQURSO0FBRW5CbEIsNEJBQTBCaUIsb0JBQVVDO0FBRmpCLENBQXJCIiwiZmlsZSI6IkNvbXBvc2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IG1lbW9pemUgZnJvbSAnbWVtb2l6ZS1vbmUnO1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5cbmltcG9ydCBDb250ZXh0IGZyb20gJy4vQ29udGV4dCc7XG5pbXBvcnQgVXR0ZXJhbmNlIGZyb20gJy4vVXR0ZXJhbmNlJztcblxuY2xhc3MgU3BlZWNoQ29udGV4dCB7XG4gIGNvbnN0cnVjdG9yKHBvbnlmaWxsKSB7XG4gICAgdGhpcy5xdWV1ZVdpdGhDdXJyZW50ID0gW107XG5cbiAgICB0aGlzLmNhbmNlbCA9IHRoaXMuY2FuY2VsLmJpbmQodGhpcyk7XG4gICAgdGhpcy5jYW5jZWxBbGwgPSB0aGlzLmNhbmNlbEFsbC5iaW5kKHRoaXMpO1xuICAgIHRoaXMuc3BlYWsgPSB0aGlzLnNwZWFrLmJpbmQodGhpcyk7XG5cbiAgICB0aGlzLnNldFBvbnlmaWxsKHBvbnlmaWxsKTtcbiAgfVxuXG4gIHNldFBvbnlmaWxsKHsgc3BlZWNoU3ludGhlc2lzLCBTcGVlY2hTeW50aGVzaXNVdHRlcmFuY2UgfSkge1xuICAgIHRoaXMucG9ueWZpbGwgPSB7IHNwZWVjaFN5bnRoZXNpcywgU3BlZWNoU3ludGhlc2lzVXR0ZXJhbmNlIH07XG4gIH1cblxuICBhc3luYyBjYW5jZWwoaWQpIHtcbiAgICBjb25zdCBpbmRleCA9IHRoaXMucXVldWVXaXRoQ3VycmVudC5maW5kSW5kZXgodXR0ZXJhbmNlID0+IHV0dGVyYW5jZS5pZCA9PT0gaWQpO1xuXG4gICAgaWYgKH5pbmRleCkge1xuICAgICAgcmV0dXJuIHRoaXMucXVldWVXaXRoQ3VycmVudFtpbmRleF0uY2FuY2VsKCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY2FuY2VsQWxsKCkge1xuICAgIC8vIGNvbnNvbGUuZGVidWcoYENBTkNFTExJTkcgUVVFVUVEIElURU1TOiAkeyB0aGlzLnF1ZXVlV2l0aEN1cnJlbnQubGVuZ3RoIH1gKTtcblxuICAgIC8vIHRoaXMucXVldWVXaXRoQ3VycmVudC5mb3JFYWNoKGVudHJ5ID0+IGVudHJ5LmNhbmNlbGxlZCA9IHRydWUpO1xuXG4gICAgLy8gY29uc3QgY2FuY2VsQWxsID0gUHJvbWlzZS5hbGwodGhpcy5xdWV1ZVdpdGhDdXJyZW50Lm1hcCgoeyBkZWZlcnJlZDogeyBwcm9taXNlIH0gfSkgPT4gcHJvbWlzZS5jYXRjaChlcnIgPT4gMCkpKTtcblxuICAgIC8vIHRoaXMucG9ueWZpbGwuc3BlZWNoU3ludGhlc2lzLmNhbmNlbCgpO1xuXG4gICAgLy8gdHJ5IHtcbiAgICAvLyAgIGF3YWl0IGNhbmNlbEFsbDtcbiAgICAvLyB9IGNhdGNoIChlcnIpIHt9XG5cbiAgICAvLyBjb25zb2xlLmRlYnVnKGBBTEwgQ0FOQ0VMTEVEIE9SIEZJTklTSEVEYCk7XG4gIH1cblxuICBzcGVhayh1dHRlcmFuY2VMaWtlKSB7XG4gICAgLy8gY29uc29sZS5kZWJ1ZyhgUVVFVUVEOiAkeyB1dHRlcmFuY2VMaWtlLnRleHQgfWApO1xuXG4gICAgaWYgKFxuICAgICAgdXR0ZXJhbmNlTGlrZS5pZFxuICAgICAgJiYgdGhpcy5xdWV1ZVdpdGhDdXJyZW50LmZpbmQoKHsgaWQgfSkgPT4gaWQgPT09IHV0dGVyYW5jZUxpa2UuaWQpXG4gICAgKSB7XG4gICAgICAvLyBEbyBub3QgcXVldWUgZHVwbGljYXRlZCBzcGVhayB3aXRoIHNhbWUgdW5pcXVlIElEXG4gICAgICAvLyBjb25zb2xlLmRlYnVnKCdOT1QgUVVFVUVJTkcgRFVQRScpO1xuXG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgdXR0ZXJhbmNlID0gbmV3IFV0dGVyYW5jZSh1dHRlcmFuY2VMaWtlKTtcblxuICAgIHRoaXMucXVldWVXaXRoQ3VycmVudCA9IFsuLi50aGlzLnF1ZXVlV2l0aEN1cnJlbnQsIHV0dGVyYW5jZV07XG5cbiAgICBpZiAodGhpcy5xdWV1ZVdpdGhDdXJyZW50Lmxlbmd0aCA9PT0gMSkge1xuICAgICAgdGhpcy5fbmV4dCgpO1xuICAgIH1cblxuICAgIHJldHVybiB1dHRlcmFuY2UuZGVmZXJyZWQucHJvbWlzZTtcbiAgfVxuXG4gIF9uZXh0KCkge1xuICAgIGNvbnN0IHV0dGVyYW5jZSA9IHRoaXMucXVldWVXaXRoQ3VycmVudFswXTtcblxuICAgIGlmICghdXR0ZXJhbmNlKSB7IHJldHVybjsgfVxuXG4gICAgY29uc3QgeyBpZCB9ID0gdXR0ZXJhbmNlO1xuICAgIGNvbnN0IHByb21pc2UgPSB1dHRlcmFuY2Uuc3BlYWsodGhpcy5wb255ZmlsbCk7XG5cbiAgICBwcm9taXNlLnRoZW4oKCkgPT4ge1xuICAgICAgdGhpcy5xdWV1ZVdpdGhDdXJyZW50ID0gdGhpcy5xdWV1ZVdpdGhDdXJyZW50LmZpbHRlcih1dHRlcmFuY2UgPT4gdXR0ZXJhbmNlLmlkICE9PSBpZCk7XG4gICAgICB0aGlzLl9uZXh0KCk7XG4gICAgfSwgKCkgPT4ge1xuICAgICAgLy8gVE9ETzogSWYgdGhlIGVycm9yIGlzIGR1ZSB0byBTYWZhcmkgcmVzdHJpY3Rpb24gb24gdXNlciB0b3VjaFxuICAgICAgLy8gICAgICAgVGhlIG5leHQgbG9vcCBvbiB0aGUgbmV4dCBhdWRpbyB3aWxsIGFsc28gZmFpbCBiZWNhdXNlIGl0IHdhcyBub3QgcXVldWVkIHdpdGggYSB1c2VyIHRvdWNoXG4gICAgICB0aGlzLnF1ZXVlV2l0aEN1cnJlbnQgPSB0aGlzLnF1ZXVlV2l0aEN1cnJlbnQuZmlsdGVyKHV0dGVyYW5jZSA9PiB1dHRlcmFuY2UuaWQgIT09IGlkKTtcbiAgICAgIHRoaXMuX25leHQoKTtcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDb21wb3NlciBleHRlbmRzIFJlYWN0LkNvbXBvbmVudCB7XG4gIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgc3VwZXIocHJvcHMpO1xuXG4gICAgdGhpcy5oYW5kbGVWb2ljZXNDaGFuZ2VkID0gdGhpcy5oYW5kbGVWb2ljZXNDaGFuZ2VkLmJpbmQodGhpcyk7XG5cbiAgICBsZXQgdm9pY2VzID0gW107XG5cbiAgICBpZiAocHJvcHMuc3BlZWNoU3ludGhlc2lzKSB7XG4gICAgICBwcm9wcy5zcGVlY2hTeW50aGVzaXMuYWRkRXZlbnRMaXN0ZW5lciAmJiBwcm9wcy5zcGVlY2hTeW50aGVzaXMuYWRkRXZlbnRMaXN0ZW5lcigndm9pY2VzY2hhbmdlZCcsIHRoaXMuaGFuZGxlVm9pY2VzQ2hhbmdlZCk7XG4gICAgICB2b2ljZXMgPSBwcm9wcy5zcGVlY2hTeW50aGVzaXMuZ2V0Vm9pY2VzKCk7XG4gICAgfVxuXG4gICAgdGhpcy5tZXJnZUNvbnRleHQgPSBtZW1vaXplKCh7IGNhbmNlbCwgc3BlYWsgfSwgdm9pY2VzKSA9PiAoe1xuICAgICAgY2FuY2VsLFxuICAgICAgc3BlYWssXG4gICAgICB2b2ljZXNcbiAgICB9KSk7XG5cbiAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgY29udGV4dDogbmV3IFNwZWVjaENvbnRleHQoe1xuICAgICAgICBzcGVlY2hTeW50aGVzaXM6IHByb3BzLnNwZWVjaFN5bnRoZXNpcyxcbiAgICAgICAgU3BlZWNoU3ludGhlc2lzVXR0ZXJhbmNlOiBwcm9wcy5zcGVlY2hTeW50aGVzaXNVdHRlcmFuY2VcbiAgICAgIH0pLFxuICAgICAgdm9pY2VzXG4gICAgfTtcbiAgfVxuXG4gIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV4dFByb3BzKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCBjaGFuZ2VkID0gW1xuICAgICAgJ3NwZWVjaFN5bnRoZXNpcycsXG4gICAgICAnc3BlZWNoU3ludGhlc2lzVXR0ZXJhbmNlJ1xuICAgIF0uc29tZShuYW1lID0+IG5leHRQcm9wc1tuYW1lXSAhPT0gcHJvcHNbbmFtZV0pO1xuXG4gICAgaWYgKGNoYW5nZWQpIHtcbiAgICAgIGlmIChwcm9wcy5zcGVlY2hTeW50aGVzaXMpIHtcbiAgICAgICAgcHJvcHMuc3BlZWNoU3ludGhlc2lzLnJlbW92ZUV2ZW50TGlzdGVuZXIgJiYgcHJvcHMuc3BlZWNoU3ludGhlc2lzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3ZvaWNlc2NoYW5nZWQnLCB0aGlzLmhhbmRsZVZvaWNlc0NoYW5nZWQpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLnN0YXRlLmNvbnRleHQuc2V0UG9ueWZpbGwoe1xuICAgICAgICBzcGVlY2hTeW50aGVzaXM6IG5leHRQcm9wcy5zcGVlY2hTeW50aGVzaXMsXG4gICAgICAgIFNwZWVjaFN5bnRoZXNpc1V0dGVyYW5jZTogbmV4dFByb3BzLnNwZWVjaFN5bnRoZXNpc1V0dGVyYW5jZVxuICAgICAgfSk7XG5cbiAgICAgIGxldCBuZXh0Vm9pY2VzID0gW107XG5cbiAgICAgIGlmIChuZXh0UHJvcHMuc3BlZWNoU3ludGhlc2lzKSB7XG4gICAgICAgIG5leHRQcm9wcy5zcGVlY2hTeW50aGVzaXMuYWRkRXZlbnRMaXN0ZW5lciAmJiBuZXh0UHJvcHMuc3BlZWNoU3ludGhlc2lzLmFkZEV2ZW50TGlzdGVuZXIoJ3ZvaWNlc2NoYW5nZWQnLCB0aGlzLmhhbmRsZVZvaWNlc0NoYW5nZWQpO1xuICAgICAgICBuZXh0Vm9pY2VzID0gbmV4dFByb3BzLnNwZWVjaFN5bnRoZXNpcy5nZXRWb2ljZXMoKSB8fCBbXTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5zZXRTdGF0ZSgoKSA9PiAoeyB2b2ljZXM6IG5leHRWb2ljZXMgfSkpO1xuICAgIH1cbiAgfVxuXG4gIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgIGNvbnN0IHsgc3BlZWNoU3ludGhlc2lzIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgc3BlZWNoU3ludGhlc2lzICYmIHNwZWVjaFN5bnRoZXNpcy5yZW1vdmVFdmVudExpc3RlbmVyICYmIHNwZWVjaFN5bnRoZXNpcy5yZW1vdmVFdmVudExpc3RlbmVyKCd2b2ljZXNjaGFuZ2VkJywgdGhpcy5oYW5kbGVWb2ljZXNDaGFuZ2VkKTtcbiAgfVxuXG4gIGhhbmRsZVZvaWNlc0NoYW5nZWQoeyB0YXJnZXQgfSkge1xuICAgIHRoaXMuc2V0U3RhdGUoKCkgPT4gKHsgdm9pY2VzOiB0YXJnZXQuZ2V0Vm9pY2VzKCkgfSkpO1xuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHsgcHJvcHMsIHN0YXRlIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgY2hpbGRyZW4gfSA9IHByb3BzO1xuXG4gICAgcmV0dXJuIChcbiAgICAgIDxDb250ZXh0LkNvbnN1bWVyPlxuICAgICAgICB7IGNvbnRleHQgPT4gY29udGV4dCA/XG4gICAgICAgICAgICB0eXBlb2YgY2hpbGRyZW4gPT09ICdmdW5jdGlvbicgPyBjaGlsZHJlbihjb250ZXh0KSA6IGNoaWxkcmVuXG4gICAgICAgICAgOlxuICAgICAgICAgICAgPENvbnRleHQuUHJvdmlkZXIgdmFsdWU9eyB0aGlzLm1lcmdlQ29udGV4dChzdGF0ZS5jb250ZXh0LCBzdGF0ZS52b2ljZXMpIH0+XG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICB0eXBlb2YgY2hpbGRyZW4gPT09ICdmdW5jdGlvbicgP1xuICAgICAgICAgICAgICAgICAgPENvbnRleHQuQ29uc3VtZXI+XG4gICAgICAgICAgICAgICAgICAgIHsgY29udGV4dCA9PiBjaGlsZHJlbihjb250ZXh0KSB9XG4gICAgICAgICAgICAgICAgICA8L0NvbnRleHQuQ29uc3VtZXI+XG4gICAgICAgICAgICAgICAgOlxuICAgICAgICAgICAgICAgICAgY2hpbGRyZW5cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgPC9Db250ZXh0LlByb3ZpZGVyPlxuICAgICAgICB9XG4gICAgICA8L0NvbnRleHQuQ29uc3VtZXI+XG4gICAgKTtcbiAgfVxufVxuXG5Db21wb3Nlci5kZWZhdWx0UHJvcHMgPSB7XG4gIHNwZWVjaFN5bnRoZXNpczogd2luZG93LnNwZWVjaFN5bnRoZXNpcyB8fCB3aW5kb3cud2Via2l0U3BlZWNoU3ludGhlc2lzLFxuICBzcGVlY2hTeW50aGVzaXNVdHRlcmFuY2U6IHdpbmRvdy5TcGVlY2hTeW50aGVzaXNVdHRlcmFuY2UgfHwgd2luZG93LndlYmtpdFNwZWVjaFN5bnRoZXNpc1V0dGVyYW5jZVxufTtcblxuQ29tcG9zZXIucHJvcFR5cGVzID0ge1xuICBzcGVlY2hTeW50aGVzaXM6IFByb3BUeXBlcy5hbnksXG4gIHNwZWVjaFN5bnRoZXNpc1V0dGVyYW5jZTogUHJvcFR5cGVzLmFueVxufTtcbiJdfQ==